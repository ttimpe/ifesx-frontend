<div class="flex flex-col h-full bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">

    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-slate-100 bg-slate-50/50">
        <div class="flex items-center gap-4">
            <a routerLink="/connections">
                <p-button icon="pi pi-arrow-left" [text]="true" severity="secondary"></p-button>
            </a>
            <div>
                <h2 class="text-lg font-bold text-slate-800 tracking-tight">{{ isNew ? 'Neuer Anschluss' : 'Anschluss
                    bearbeiten' }}</h2>
            </div>
        </div>
        <div class="flex gap-2">
            <p-button label="Speichern" icon="pi pi-check" severity="success" (onClick)="save()"></p-button>
        </div>
    </div>

    <div class="flex-1 overflow-auto bg-slate-50 p-4">
        <div class="max-w-6xl mx-auto flex flex-col gap-6">

            <!-- Meta Card -->
            <p-card styleClass="shadow-sm border border-slate-200 rounded-xl overflow-hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Basis Version -->
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-slate-700">Nr (EINAN_NR)</label>
                        <p-inputNumber [(ngModel)]="item.EINAN_NR" [disabled]="!isNew" [useGrouping]="false"
                            styleClass="w-full" class="w-full block"></p-inputNumber>
                    </div>

                    <!-- Name -->
                    <div class="flex flex-col gap-2">
                        <label class="text-sm font-medium text-slate-700">Anschluss Name</label>
                        <input pInputText [(ngModel)]="item.ANSCHLUSS_NAME" class="w-full" />
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- ZUBRINGER -->
                    <div class="flex flex-col gap-4 p-4 bg-blue-50/50 rounded-lg border border-blue-100">
                        <h3 class="font-bold text-blue-800 flex items-center gap-2">
                            <i class="pi pi-arrow-right"></i> Zubringer
                        </h3>

                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-slate-700">Linie</label>
                            <p-dropdown [options]="lines" [(ngModel)]="item.ZUB_LI_NR" optionLabel="LI_KUERZEL"
                                optionValue="LI_NR" [filter]="true" filterBy="LI_KUERZEL,LI_NR"
                                placeholder="Linie wählen" styleClass="w-full"></p-dropdown>
                        </div>

                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-slate-700">Richtung</label>
                            <p-dropdown [options]="directionOptions" [(ngModel)]="item.ZUB_LI_RI_NR" optionLabel="label"
                                optionValue="value" styleClass="w-full"></p-dropdown>
                        </div>

                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-slate-700">Haltestelle (REF_ORT)</label>
                            <p-dropdown [options]="stops" [(ngModel)]="item.ZUB_ORT_REF_ORT" optionLabel="ORT_NAME"
                                optionValue="ORT_NR" [filter]="true" filterBy="ORT_NAME,ORT_NR" [virtualScroll]="true"
                                [itemSize]="30" placeholder="Haltestelle wählen" styleClass="w-full"></p-dropdown>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-slate-700">ASBID (Optional)</label>
                            <input pInputText [(ngModel)]="item.ASBID" class="w-full" />
                        </div>
                    </div>

                    <!-- ABBRINGER -->
                    <div class="flex flex-col gap-4 p-4 bg-orange-50/50 rounded-lg border border-orange-100">
                        <h3 class="font-bold text-orange-800 flex items-center gap-2">
                            <i class="pi pi-arrow-right"></i> Abbringer
                        </h3>

                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-slate-700">Linie</label>
                            <p-dropdown [options]="lines" [(ngModel)]="item.ABB_LI_NR" optionLabel="LI_KUERZEL"
                                optionValue="LI_NR" [filter]="true" filterBy="LI_KUERZEL,LI_NR"
                                placeholder="Linie wählen" styleClass="w-full"></p-dropdown>
                        </div>

                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-slate-700">Richtung</label>
                            <p-dropdown [options]="directionOptions" [(ngModel)]="item.ABB_LI_RI_NR" optionLabel="label"
                                optionValue="value" styleClass="w-full"></p-dropdown>
                        </div>

                        <div class="flex flex-col gap-2">
                            <label class="text-sm font-medium text-slate-700">Haltestelle (REF_ORT)</label>
                            <p-dropdown [options]="stops" [(ngModel)]="item.ABB_ORT_REF_ORT" optionLabel="ORT_NAME"
                                optionValue="ORT_NR" [filter]="true" filterBy="ORT_NAME,ORT_NR" [virtualScroll]="true"
                                [itemSize]="30" placeholder="Haltestelle wählen" styleClass="w-full"></p-dropdown>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end" *ngIf="!isNew">
                    <p-button label="Löschen" icon="pi pi-trash" severity="danger" [outlined]="true"
                        (onClick)="delete()"></p-button>
                </div>
            </p-card>

            <!-- REC_UMS Section -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mt-4" *ngIf="!isNew">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                    <h3 class="text-lg font-bold text-slate-800">Überwachungsregeln (REC_UMS)</h3>
                </div>

                <div class="p-6 border-b border-slate-100 bg-slate-50/20">
                    <h4 class="text-sm font-bold text-slate-700 mb-4">Neue Regel hinzufügen</h4>
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4 items-end">
                        <div class="flex flex-col gap-2 col-span-2 md:col-span-1">
                            <label class="text-xs font-medium text-slate-500 uppercase">Tagesart</label>
                            <p-dropdown [options]="tagesarten" [(ngModel)]="newUms.TAGESART_NR"
                                optionLabel="TAGESART_TEXT" optionValue="TAGESART_NR" placeholder="Tagesart"
                                styleClass="w-full" appendTo="body"></p-dropdown>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-medium text-slate-500 uppercase">Beginn (s)</label>
                            <p-inputNumber [(ngModel)]="newUms.UMS_BEGINN" [useGrouping]="false" styleClass="w-full"
                                class="w-full block"></p-inputNumber>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-medium text-slate-500 uppercase">Ende (s)</label>
                            <p-inputNumber [(ngModel)]="newUms.UMS_ENDE" [useGrouping]="false" styleClass="w-full"
                                class="w-full block"></p-inputNumber>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-medium text-slate-500 uppercase">Min (s)</label>
                            <p-inputNumber [(ngModel)]="newUms.UMS_MIN" [useGrouping]="false" styleClass="w-full"
                                class="w-full block"></p-inputNumber>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-medium text-slate-500 uppercase">Max (s)</label>
                            <p-inputNumber [(ngModel)]="newUms.UMS_MAX" [useGrouping]="false" styleClass="w-full"
                                class="w-full block"></p-inputNumber>
                        </div>
                        <div>
                            <p-button label="Add" icon="pi pi-plus" (onClick)="addUms()" styleClass="w-full"></p-button>
                        </div>
                    </div>
                </div>

                <div class="p-0">
                    <p-table [value]="item.recUms || []" styleClass="p-datatable-sm p-datatable-striped"
                        [rowHover]="true">
                        <ng-template pTemplate="header">
                            <tr>
                                <th>Tagesart</th>
                                <th>Zeitraum</th>
                                <th>Min Transfer</th>
                                <th>Max Transfer</th>
                                <th>Max Verzögerung (Man/Auto)</th>
                                <th class="text-right">Aktionen</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-ums let-rowIndex="rowIndex">
                            <tr>
                                <td>{{ ums.TAGESART_NR }}</td>
                                <td>{{ ums.UMS_BEGINN }}s - {{ ums.UMS_ENDE }}s</td>
                                <td class="font-bold text-green-600">{{ ums.UMS_MIN }}s</td>
                                <td class="font-bold text-red-600">{{ ums.UMS_MAX }}s</td>
                                <td>{{ ums.MAX_VERZ_MAN }}s / {{ ums.MAX_VERZ_AUTO }}s</td>
                                <td class="text-right">
                                    <p-button icon="pi pi-trash" [text]="true" severity="danger" size="small"
                                        (onClick)="removeUms(ums, rowIndex)"></p-button>
                                </td>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="6" class="text-center p-6 text-slate-400">
                                    Keine Regeln definiert.
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>

        </div>
    </div>
</div>