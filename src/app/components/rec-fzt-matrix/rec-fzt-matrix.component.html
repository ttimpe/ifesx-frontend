<div class="flex flex-col h-full bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
    <!-- Header Toolbar -->
    <div class="flex items-center justify-between p-4 border-b border-slate-100 bg-slate-50/50">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center">
                <i class="pi pi-table text-xl"></i>
            </div>
            <div>
                <h2 class="text-lg font-bold text-slate-800 tracking-tight">Fahrzeiten-Matrix</h2>
                <p class="text-xs text-slate-500 font-medium">{{rows.length}} Fahrzeiten gefunden</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <label class="font-semibold text-sm text-slate-700">Bereich:</label>
            <p-select [options]="bereiche" [(ngModel)]="selectedBereichNr" (onChange)="onBereichChange()"
                optionLabel="STR_BEREICH" optionValue="BEREICH_NR" [style]="{'width':'300px'}"
                placeholder="Bereich wählen" [showClear]="false">
                <ng-template pTemplate="selectedItem" let-selectedOption>
                    <div class="flex align-items-center gap-2" *ngIf="selectedOption">
                        <span>{{ selectedOption.BEREICH_NR }} - {{ selectedOption.STR_BEREICH }}</span>
                    </div>
                </ng-template>
                <ng-template let-b pTemplate="item">
                    <div class="flex align-items-center gap-2">
                        <div>{{b.BEREICH_NR}} - {{b.STR_BEREICH}} <small
                                class="text-xs text-gray-500">({{b.BEREICH_TEXT}})</small></div>
                    </div>
                </ng-template>
            </p-select>

            <label class="font-semibold text-sm text-slate-700">FGR:</label>
            <p-select [options]="fgrs" [(ngModel)]="selectedFgrNr" (onChange)="onFgrChange()" optionLabel="FGR_TEXT"
                optionValue="FGR_NR" [style]="{'width':'200px'}" placeholder="Alle FGR" [showClear]="true">
                <ng-template pTemplate="selectedItem" let-selectedOption>
                    <div class="flex align-items-center gap-2" *ngIf="selectedOption">
                        <span>{{ selectedOption.STR_FGR }} - {{ selectedOption.FGR_TEXT }}</span>
                    </div>
                </ng-template>
                <ng-template let-fgr pTemplate="item">
                    <div class="flex align-items-center gap-2">
                        <div>{{fgr.STR_FGR}} <small class="text-xs text-slate-500">({{fgr.FGR_TEXT}})</small></div>
                    </div>
                </ng-template>
            </p-select>

            <p-button label="Hinzufügen" icon="pi pi-plus" (onClick)="openAddDialog()" severity="success"
                size="small"></p-button>
        </div>
    </div>

    <!-- Table -->
    <div class="flex-1 overflow-auto bg-white p-2">
        <p-table [value]="rows" [loading]="loading" [paginator]="true" [rows]="25"
            [rowsPerPageOptions]="[25, 50, 100, 500]" styleClass="p-datatable-striped"
            [tableStyle]="{ 'min-width': '50rem' }">

            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="ORT_NAME" class="font-semibold text-sm text-slate-700">Von Ort <p-sortIcon
                            field="ORT_NAME"></p-sortIcon></th>
                    <th pSortableColumn="SEL_ZIEL_NAME" class="font-semibold text-sm text-slate-700">Nach Ort
                        <p-sortIcon field="SEL_ZIEL_NAME"></p-sortIcon></th>
                    <th pSortableColumn="SEL_FZT" class="font-semibold text-sm text-slate-700">Fahrzeit (Sek)
                        <p-sortIcon field="SEL_FZT"></p-sortIcon></th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-row>
                <tr>
                    <td>{{row.ORT_NAME}} <small class="text-slate-500">({{row.ORT_NR}})</small></td>
                    <td>{{row.SEL_ZIEL_NAME}} <small class="text-slate-500">({{row.SEL_ZIEL}})</small></td>
                    <td>
                        <p-inputNumber [(ngModel)]="row.SEL_FZT" (onInput)="updateTime(row, $event.value)" [min]="0"
                            [showButtons]="true" buttonLayout="horizontal" inputId="minmax-buttons" mode="decimal"
                            [step]="10" decrementButtonClass="p-button-secondary"
                            incrementButtonClass="p-button-secondary" incrementButtonIcon="pi pi-plus"
                            decrementButtonIcon="pi pi-minus" [inputStyle]="{'width': '80px', 'text-align': 'center'}">
                        </p-inputNumber>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="3" class="text-center p-4">Keine Fahrzeiten gefunden.</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- Add FZT Dialog -->
<p-dialog [(visible)]="showAddDialog" header="Fahrzeit hinzufügen" [modal]="true" [style]="{width: '500px'}">
    <div class="flex flex-col gap-4 py-4">
        <div class="flex flex-col gap-2">
            <label class="font-bold text-sm text-slate-600">Von Ort</label>
            <p-select [options]="stops" [(ngModel)]="newFzt.ORT_NR" optionValue="ORT_NR" optionLabel="ORT_NAME"
                [filter]="true" filterBy="ORT_NAME,ORT_NR" appendTo="body" placeholder="Start auswählen"
                styleClass="w-full"></p-select>
        </div>

        <div class="flex flex-col gap-2">
            <label class="font-bold text-sm text-slate-600">Nach Ort</label>
            <p-select [options]="stops" [(ngModel)]="newFzt.SEL_ZIEL" optionValue="ORT_NR" optionLabel="ORT_NAME"
                [filter]="true" filterBy="ORT_NAME,ORT_NR" appendTo="body" placeholder="Ziel auswählen"
                styleClass="w-full"></p-select>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col gap-2">
                <label class="font-bold text-sm text-slate-600">Fahrzeitgruppe (FGR)</label>
                <p-select [options]="fgrs" [(ngModel)]="newFzt.FGR_NR" optionValue="FGR_NR" optionLabel="STR_FGR"
                    appendTo="body" placeholder="FGR auswählen" styleClass="w-full">
                    <ng-template let-fgr pTemplate="item">
                        <div>{{fgr.STR_FGR}} <small class="text-xs text-slate-400">({{fgr.FGR_TEXT}})</small></div>
                    </ng-template>
                </p-select>
            </div>
            <div class="flex flex-col gap-2">
                <label class="font-bold text-sm text-slate-600">Fahrzeit (Sekunden)</label>
                <p-inputNumber [(ngModel)]="newFzt.SEL_FZT" styleClass="w-full"></p-inputNumber>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-end gap-2">
            <p-button label="Abbrechen" icon="pi pi-times" [text]="true" severity="secondary"
                (onClick)="showAddDialog = false"></p-button>
            <p-button label="Speichern" icon="pi pi-check" (onClick)="onAdd()"
                [disabled]="!newFzt.ORT_NR || !newFzt.SEL_ZIEL"></p-button>
        </div>
    </ng-template>
</p-dialog>