<!-- calendar-overview.component.html -->
<div class="container mx-auto p-4 max-w-7xl animate-fade-in">

  <!-- Integrated Header -->
  <div class="bg-white border border-slate-200 px-6 py-4 rounded-xl shadow-sm mb-6 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center">
        <i class="pi pi-calendar text-xl"></i>
      </div>
      <div>
        <h1 class="text-lg font-bold text-slate-800 tracking-tight">Firmenkalender</h1>
        <p class="text-xs text-slate-500 font-medium">Verwaltung von Betriebstagen und Tagesarten</p>
      </div>
    </div>
  </div>
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Tollbar -->
  <div class="mb-4 flex gap-2 px-1">
    <p-button label="Neue Basis-Version" icon="pi pi-plus" (onClick)="startCreateVersion()"
      severity="success"></p-button>
    <p-button label="GTFS Import Assistent" icon="pi pi-upload" (onClick)="navigateToGtfs()" severity="help"
      [disabled]="!selectedBasisVersion" pTooltip="Importiert GTFS Daten in die aktuelle Version"></p-button>
  </div>

  <div class="flex flex-col gap-6">

    <!-- Fahrplan Date Range Card -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
      <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
        <h3 class="font-bold text-slate-800 flex items-center gap-2">
          <i class="pi pi-calendar text-blue-500"></i> Fahrplanperiode
        </h3>
      </div>

      <div class="p-6">
        <!-- Version Display -->
        <div *ngIf="selectedBasisVersion && !isEditingVersion"
          class="flex items-center gap-3 mb-6 p-3 bg-blue-50/50 rounded-lg border border-blue-100">
          <div class="flex flex-col">
            <span class="text-xs font-bold uppercase text-blue-500 tracking-wider">Aktive Basis-Version</span>
            <span class="font-mono text-lg font-bold text-slate-800">{{ selectedBasisVersion.BASIS_VERSION }} - {{
              selectedBasisVersion.BASIS_VERSION_TEXT }}</span>
          </div>
          <p-button icon="pi pi-pencil" [text]="true" severity="warn" size="small" (onClick)="startEditVersion()"
            pTooltip="Bezeichnung bearbeiten"></p-button>
        </div>
        <!-- Edit Version -->
        <div *ngIf="isEditingVersion"
          class="flex items-end gap-2 mb-6 p-4 bg-slate-50 rounded-lg border border-slate-200">
          <div class="flex flex-col gap-1 flex-1">
            <label class="text-xs font-bold uppercase text-slate-500">Bezeichnung</label>
            <input pInputText [(ngModel)]="editVersionText" class="w-full" />
          </div>
          <div class="flex gap-2">
            <p-button icon="pi pi-check" label="Speichern" (onClick)="saveVersion()" severity="success"></p-button>
            <p-button icon="pi pi-times" label="Abbrechen" (onClick)="cancelEditVersion()" severity="secondary"
              [outlined]="true"></p-button>
          </div>
        </div>

        <!-- Date Range Picker -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div class="flex flex-col gap-2">
            <label class="text-sm font-medium text-slate-600">Fahrplan ab</label>
            <p-datePicker [(ngModel)]="beginDate" dateFormat="yy-mm-dd" [showIcon]="true" styleClass="w-full"
              inputStyleClass="w-full"></p-datePicker>
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-sm font-medium text-slate-600">Fahrplan bis</label>
            <p-datePicker [(ngModel)]="endDate" dateFormat="yy-mm-dd" [showIcon]="true" styleClass="w-full"
              inputStyleClass="w-full"></p-datePicker>
          </div>
          <div>
            <p-button label="Speichern" icon="pi pi-save" severity="success" (onClick)="saveDateRange()"
              styleClass="w-full"></p-button>
          </div>
        </div>
        <small class="block mt-2 text-slate-400 text-xs">Definiert den globalen Zeitraum für diesen Fahrplan.</small>

        <!-- Delete Version Button -->
        <div class="mt-6 pt-6 border-t border-slate-200">
          <p-button label="Basis-Version löschen" icon="pi pi-trash" severity="danger" size="small"
            (onClick)="deleteCurrentVersion()" [disabled]="!selectedBasisVersion"
            pTooltip="Löscht die aktuelle Version und alle zugehörigen Daten">
          </p-button>
          <small class="block mt-2 text-slate-400 text-xs">
            Achtung: Löscht alle Daten dieser Version unwiderruflich!
          </small>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Tagesarten (Day Types) -->
      <div class="flex flex-col gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden h-full flex flex-col">
          <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
            <h3 class="font-bold text-slate-800">Tagesarten</h3>
            <p-button label="Neu" icon="pi pi-plus" severity="success" size="small"
              (onClick)="openTagesartModal()"></p-button>
          </div>
          <div class="flex-1 overflow-auto bg-white p-2">
            <p-table [value]="daytypes" [rows]="10" [paginator]="true" styleClass="p-datatable-striped"
              [rowHover]="true">
              <ng-template pTemplate="header">
                <tr>
                  <th pSortableColumn="TAGESART_NR" style="width: 20%">Nr <p-sortIcon field="TAGESART_NR"></p-sortIcon>
                  </th>
                  <th pSortableColumn="TAGESART_TEXT">Beschreibung <p-sortIcon field="TAGESART_TEXT"></p-sortIcon></th>
                  <th style="width: 20%">Aktionen</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-type>
                <tr>
                  <td class="font-mono">{{ type.TAGESART_NR }}</td>
                  <td>{{ type.TAGESART_TEXT }}</td>
                  <td>
                    <div class="flex gap-1">
                      <p-button icon="pi pi-pencil" [text]="true" severity="warn" size="small"
                        (onClick)="openTagesartModal(type)"></p-button>
                      <p-button icon="pi pi-trash" [text]="true" severity="danger" size="small"
                        (onClick)="deleteDaytype(type)"></p-button>
                    </div>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </div>

      <!-- Betriebstage (Working Days) List -->
      <div class="flex flex-col gap-4">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden h-full flex flex-col">
          <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
            <h3 class="font-bold text-slate-800">Spezielle Betriebstage</h3>
            <p-button label="Neu" icon="pi pi-plus" severity="success" size="small"
              (onClick)="openBetriebstagModal()"></p-button>
          </div>
          <div class="flex-1 overflow-auto bg-white p-2">
            <p-table [value]="betriebstage" [rows]="10" [paginator]="true" styleClass="p-datatable-striped"
              [rowHover]="true">
              <ng-template pTemplate="header">
                <tr>
                  <th pSortableColumn="BETRIEBSTAG" style="width: 30%">Datum <p-sortIcon
                      field="BETRIEBSTAG"></p-sortIcon></th>
                  <th pSortableColumn="BETRIEBSTAG_TEXT">Beschreibung <p-sortIcon field="BETRIEBSTAG_TEXT"></p-sortIcon>
                  </th>
                  <th pSortableColumn="TAGESART_NR" style="width: 20%">Typ <p-sortIcon field="TAGESART_NR"></p-sortIcon>
                  </th>
                  <th style="width: 20%">Ops</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-day>
                <tr>
                  <td class="font-mono">{{ day.BETRIEBSTAG }}</td>
                  <td>{{ day.BETRIEBSTAG_TEXT }}</td>
                  <td><span class="px-2 py-1 bg-slate-100 rounded text-xs font-bold">{{ day.tagesart?.TAGESART_TEXT ||
                      day.TAGESART_NR }}</span></td>
                  <td>
                    <div class="flex gap-1">
                      <p-button icon="pi pi-pencil" [text]="true" severity="warn" size="small"
                        (onClick)="openBetriebstagModal(day)"></p-button>
                      <p-button icon="pi pi-trash" [text]="true" severity="danger" size="small"
                        (onClick)="deleteBetriebstag(day)"></p-button>
                    </div>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </div>
      </div>
    </div>

    <!-- Year Calendar & Batch Assignment -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
      <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
        <h3 class="font-bold text-slate-800">Kalender Übersicht & Zuweisung</h3>
        <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-bold">{{ selectedDates.length }} Tage
          markiert</span>
      </div>
      <div class="p-4 bg-slate-50 border-b border-slate-100 flex flex-wrap items-end gap-4">
        <div class="flex flex-col gap-2 flex-1 min-w-[200px]">
          <label class="text-xs font-bold uppercase text-slate-500">Tagesart zuweisen</label>
          <p-select [options]="daytypes" [(ngModel)]="selectedTagesartForBatch" optionLabel="TAGESART_TEXT"
            placeholder="Tagesart wählen..." [style]="{'width':'100%'}" appendTo="body"></p-select>
        </div>
        <p-button label="Zuweisen" icon="pi pi-check-circle" severity="success" (onClick)="batchAssignTagesart()"
          [disabled]="!selectedTagesartForBatch || selectedDates.length === 0"></p-button>
        <p-button label="Auswahl leeren" icon="pi pi-times" [outlined]="true" severity="secondary"
          (onClick)="yearCalendar.clearSelection()" [disabled]="selectedDates.length === 0"></p-button>
      </div>

      <div class="p-6">
        <app-year-calendar #yearCalendar [beginDate]="_beginDate" [endDate]="_endDate" [betriebstage]="betriebstage"
          [tagesarten]="daytypes" (datesSelected)="onDatesSelected($event)"></app-year-calendar>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Tagesart (PrimeNG Dialog) -->
<p-dialog header="Tagesart" [(visible)]="displayTagesartModal" [modal]="true" [style]="{width: '450px'}"
  styleClass="p-fluid">
  <div class="flex flex-col gap-4" *ngIf="selectedDayType">
    <div class="flex flex-col gap-2">
      <label for="dnr" class="font-bold">Nummer</label>
      <p-inputNumber id="dnr" [(ngModel)]="selectedDayType.TAGESART_NR"
        [disabled]="!!selectedDayType.id"></p-inputNumber>
    </div>
    <div class="flex flex-col gap-2">
      <label for="dtext" class="font-bold">Beschreibung</label>
      <input pInputText id="dtext" [(ngModel)]="selectedDayType.TAGESART_TEXT" />
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Abbrechen" icon="pi pi-times" (onClick)="displayTagesartModal = false" [text]="true"
      severity="secondary"></p-button>
    <p-button label="Speichern" icon="pi pi-check" severity="success" (onClick)="saveTagesart()"
      [text]="true"></p-button>
  </ng-template>
</p-dialog>

<!-- Modal: Betriebstag (PrimeNG Dialog) -->
<p-dialog header="Betriebstag" [(visible)]="displayBetriebstagModal" [modal]="true" [style]="{width: '450px'}"
  styleClass="p-fluid">
  <div class="flex flex-col gap-4" *ngIf="selectedBetriebstag">
    <div class="flex flex-col gap-2">
      <label for="bdatum" class="font-bold">Datum (YYYYMMDD)</label>
      <p-inputNumber id="bdatum" [(ngModel)]="selectedBetriebstag.BETRIEBSTAG" [useGrouping]="false"
        placeholder="20241225"></p-inputNumber>
      <small class="text-slate-500">Format: YYYYMMDD</small>
    </div>
    <div class="flex flex-col gap-2">
      <label for="btext" class="font-bold">Beschreibung</label>
      <input pInputText id="btext" [(ngModel)]="selectedBetriebstag.BETRIEBSTAG_TEXT" />
    </div>
    <div class="flex flex-col gap-2">
      <label for="btype" class="font-bold">Tagesart</label>
      <p-select [options]="daytypes" [(ngModel)]="selectedBetriebstag.TAGESART_NR" optionValue="TAGESART_NR"
        optionLabel="TAGESART_TEXT" placeholder="Tagesart wählen..." appendTo="body"></p-select>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button label="Abbrechen" icon="pi pi-times" (onClick)="displayBetriebstagModal = false" [text]="true"
      severity="secondary"></p-button>
    <p-button label="Speichern" icon="pi pi-check" severity="success" (onClick)="saveBetriebstag()"
      [text]="true"></p-button>
  </ng-template>
</p-dialog>